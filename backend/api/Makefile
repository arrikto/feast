.PHONY: all go_client go_http_client swagger python_http_client

IMPORT_PATHS = -I . \
	-I $(GOPATH)/pkg/mod/github.com/googleapis/googleapis* \
	-I $(GOPATH)/pkg/mod/github.com/grpc-ecosystem/grpc-gateway/v2@v2.6.0

GO_PACKAGE = github.com/feast-dev/feast/backend/api/go_client

all: go_client swagger go_http_client python_http_client

go_client:
	@echo "\033[0;32mBuilding Go client from proto\033[0m\n"
	protoc $(IMPORT_PATHS) \
		--plugin=protoc-gen-go=$(GOPATH)/bin/protoc-gen-go \
    	--go-grpc_out=./go_client \
    	--go-grpc_opt=module=$(GO_PACKAGE) \
    	--go-grpc_opt=require_unimplemented_servers=false \
    	--go_out=./go_client \
    	--go_opt=module=$(GO_PACKAGE) \
    	./*.proto
	protoc $(IMPORT_PATHS) \
		--plugin=protoc-gen-grpc-gateway=$(GOPATH)/bin/protoc-gen-grpc-gateway \
    	--grpc-gateway_out=logtostderr=true:./go_client \
    	--grpc-gateway_opt=module=$(GO_PACKAGE) \
    	./*.proto

swagger: go_client
	@echo "\033[0;32mCreating Swagger specification from proto\033[0m\n"
	protoc $(IMPORT_PATHS) \
		--plugin=protoc-gen-swagger=$(GOPATH)/bin/protoc-gen-swagger \
    	--swagger_out=logtostderr=true:./swagger \
    	./*.proto
	jq -s 'reduce .[] as $$item ({}; . * $$item) | .info.title = "Feast Registry API" | .info.description = "This file contains REST API specification for Feast Registry. The file is autogenerated from the swagger definition." | .info.version = "0.0.1"'  \
    	./swagger/DataSourceService.swagger.json \
		./swagger/EntityService.swagger.json \
		./swagger/FeatureServiceService.swagger.json \
		./swagger/FeatureViewService.swagger.json \
		./swagger/InfraObjectService.swagger.json \
		./swagger/OnDemandFeatureViewService.swagger.json \
    	./swagger/ProjectService.swagger.json \
		./swagger/RequestFeatureViewService.swagger.json \
		./swagger/SavedDatasetService.swagger.json \
    	> "./swagger/frs_api_single_file.swagger.json"

go_http_client: swagger
	@echo "\033[0;32mBuilding Go HTTP client from swagger\033[0m\n"
	swagger generate client \
    	-f ./swagger/DataSourceService.swagger.json \
    	-A data_source \
    	--principal models.Principal \
    	-c data_source_client \
   		-m data_source_model \
    	-t ./go_http_client
	swagger generate client \
    	-f ./swagger/EntityService.swagger.json \
    	-A entity \
    	--principal models.Principal \
    	-c entity_client \
   		-m entity_model \
    	-t ./go_http_client
	swagger generate client \
    	-f ./swagger/FeatureServiceService.swagger.json \
    	-A feature_service \
    	--principal models.Principal \
    	-c feature_service_client \
   		-m feature_service_model \
    	-t ./go_http_client
	swagger generate client \
    	-f ./swagger/FeatureViewService.swagger.json \
    	-A feature_view \
    	--principal models.Principal \
    	-c feature_view_client \
   		-m feature_view_model \
    	-t ./go_http_client
	swagger generate client \
    	-f ./swagger/InfraObjectService.swagger.json \
    	-A infra_object \
    	--principal models.Principal \
    	-c infra_object_client \
   		-m infra_object_model \
    	-t ./go_http_client
	swagger generate client \
    	-f ./swagger/OnDemandFeatureViewService.swagger.json \
    	-A on_demand_feature_view \
    	--principal models.Principal \
    	-c on_demand_feature_view_client \
   		-m on_demand_feature_view_model \
    	-t ./go_http_client
	swagger generate client \
    	-f ./swagger/ProjectService.swagger.json \
    	-A project \
    	--principal models.Principal \
    	-c project_client \
   		-m project_model \
    	-t ./go_http_client
	swagger generate client \
    	-f ./swagger/RequestFeatureViewService.swagger.json \
    	-A request_feature_view \
    	--principal models.Principal \
    	-c request_feature_view_client \
   		-m request_feature_view_model \
    	-t ./go_http_client
	swagger generate client \
    	-f ./swagger/SavedDatasetService.swagger.json \
    	-A saved_dataset \
    	--principal models.Principal \
    	-c saved_dataset_client \
   		-m saved_dataset_model \
    	-t ./go_http_client
	go generate ./...

python_http_client: swagger
	bash build_frs_api_python_package.sh

clean:
	rm go_client/*
	rm -r go_http_client/*
	rm swagger/*
	rm -rf python_http_client/
